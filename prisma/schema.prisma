generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  PM
  EDITOR
  CLIENT_VIEWER
}

enum ProjectStatus {
  DRAFT
  IN_PROGRESS
  CLIENT_REVIEW
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum FeedbackStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum FeedbackCategory {
  CONTENT
  DESIGN
  SOUND
  LEGAL
  OTHER
}

enum AuthorType {
  USER
  CLIENT
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

enum ScopeLabel {
  IN_SCOPE
  OUT_OF_SCOPE
  UNCLEAR
}

enum PMDecision {
  APPROVED
  REJECTED
  NEEDS_INFO
}

enum WorkflowStageName {
  BRIEFING
  PRODUCTION
  CLIENT_REVIEW
  REVISIONS
  APPROVAL
  DELIVERY
  COMPLETED
}

enum NotificationChannel {
  EMAIL
  SLACK
  SMS
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
}

enum SubscriptionPlan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELLED
}

enum VersionStatus {
  DRAFT
  IN_REVIEW
  CHANGES_REQUESTED
  APPROVED
  FINAL
}

enum VideoProvider {
  KINESCOPE
  EXTERNAL_URL
  YOUTUBE_LEGACY
}

enum VideoProcessingStatus {
  UPLOADING
  PROCESSING
  READY
  FAILED
}

model Tenant {
  id            String           @id @default(cuid())
  name          String
  slug          String           @unique
  plan          SubscriptionPlan @default(STARTER)
  timezone      String           @default("UTC")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  users         User[]
  clients       ClientAccount[]
  projects      Project[]
  notifications Notification[]
  subscriptions Subscription[]
  auditLogs     AuditLog[]
  videoUploads  VideoUploadSession[]
}

model User {
  id               String          @id @default(cuid())
  tenantId         String
  role             UserRole
  firstName        String
  lastName         String
  email            String
  passwordHash     String?
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projectLinks     ProjectMember[]
  uploadedVersions AssetVersion[]  @relation("UserUploadedVersions")
  feedbackItems    FeedbackItem[]  @relation("UserFeedback")
  assignedTasks    AITask[]        @relation("UserAssignedTasks")
  pmScopeDecisions ScopeDecision[] @relation("PMScopeDecisions")
  ownedStages      WorkflowStage[] @relation("UserOwnedStages")

  @@unique([tenantId, email])
}

model ClientAccount {
  id          String   @id @default(cuid())
  tenantId    String
  companyName String
  contactName String
  email       String
  phone       String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects    Project[]
}

model Project {
  id                   String         @id @default(cuid())
  tenantId             String
  clientAccountId      String
  portalToken          String         @unique @default(cuid())
  name                 String
  description          String?
  status               ProjectStatus  @default(DRAFT)
  dueDate              DateTime?
  budget               Decimal?
  scopeDocUrl          String?
  maxRevisions         Int            @default(3)
  currentRevisionCount Int            @default(0)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  tenant               Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client               ClientAccount  @relation(fields: [clientAccountId], references: [id], onDelete: Restrict)
  versions             AssetVersion[]
  members              ProjectMember[]
  tasks                AITask[]
  scopeDecisions       ScopeDecision[]
  workflowStages       WorkflowStage[]
  videoUploads         VideoUploadSession[]
}

model ProjectMember {
  id           String   @id @default(cuid())
  projectId     String
  userId        String
  roleOnProject String
  createdAt     DateTime @default(now())
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model AssetVersion {
  id               String         @id @default(cuid())
  projectId        String
  versionNo        Int
  fileUrl          String
  fileKey          String
  fileName         String
  fileSize         Int
  durationSec      Int?
  thumbnailUrl     String?
  uploadedByUserId String
  uploadedByLegacy String?        @map("uploadedBy")
  notes            String?
  changeLog        String?        @db.Text
  status           VersionStatus  @default(DRAFT)
  approvedBy       String?
  approvedAt       DateTime?
  videoProvider    VideoProvider        @default(EXTERNAL_URL)
  kinescopeVideoId String?
  kinescopeAssetId String?
  kinescopeProjectId String?
  streamUrl        String?
  processingStatus VideoProcessingStatus @default(READY)
  processingError  String?              @db.Text
  createdAt        DateTime       @default(now())
  project          Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy       User           @relation("UserUploadedVersions", fields: [uploadedByUserId], references: [id], onDelete: Cascade)
  feedbackItems    FeedbackItem[]

  @@unique([projectId, versionNo])
  @@index([uploadedByUserId])
  @@index([kinescopeVideoId])
}

model VideoUploadSession {
  id               String              @id @default(cuid())
  tenantId         String
  projectId        String
  kinescopeVideoId String              @unique
  fileName         String
  fileType         String
  fileSize         Int
  status           VideoProcessingStatus @default(UPLOADING)
  streamUrl        String?
  durationSec      Int?
  errorMessage     String?             @db.Text
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  tenant           Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project          Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([tenantId, projectId])
}

model FeedbackItem {
  id             String           @id @default(uuid())
  assetVersionId String
  authorType     AuthorType
  authorId       String?
  authorEmail    String?
  authorName     String?
  timecodeSec    Int?
  text           String
  status         FeedbackStatus   @default(NEW)
  category       FeedbackCategory?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  assetVersion   AssetVersion     @relation(fields: [assetVersionId], references: [id], onDelete: Cascade)
  author         User?            @relation("UserFeedback", fields: [authorId], references: [id])
  scopeDecision  ScopeDecision?

  @@index([assetVersionId])
  @@index([authorId])
  @@index([status])
}

model AITask {
  id               String           @id @default(uuid())
  projectId         String
  title             String
  description       String?
  status            TaskStatus      @default(TODO)
  priority          TaskPriority    @default(MEDIUM)
  category          FeedbackCategory
  assignedToUserId  String?
  estimatedMinutes  Int?
  dueDate           DateTime?
  completedAt       DateTime?
  sourceFeedbackIds String[]
  aiGenerated       Boolean         @default(false)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  project           Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo        User?           @relation("UserAssignedTasks", fields: [assignedToUserId], references: [id])

  @@index([projectId])
  @@index([assignedToUserId])
  @@index([status])
  @@index([priority])
}

model ScopeDecision {
  id                 String       @id @default(cuid())
  projectId           String
  feedbackItemId      String       @unique
  aiLabel             ScopeLabel
  aiConfidence        Float
  aiReasoning         String?
  pmDecision          PMDecision?
  pmReason            String?
  changeRequestAmount Decimal?
  decidedBy           String?
  decidedAt           DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  project             Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  feedbackItem        FeedbackItem @relation(fields: [feedbackItemId], references: [id], onDelete: Cascade)
  pmUser              User?        @relation("PMScopeDecisions", fields: [decidedBy], references: [id])

  @@index([projectId])
  @@index([aiLabel])
  @@index([pmDecision])
}

model WorkflowStage {
  id          String            @id @default(uuid())
  projectId   String
  stageName   WorkflowStageName
  slaHours    Int
  startedAt   DateTime?
  completedAt DateTime?
  ownerUserId String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  owner   User?   @relation("UserOwnedStages", fields: [ownerUserId], references: [id])

  @@unique([projectId, stageName])
  @@index([projectId])
  @@index([stageName])
  @@index([startedAt])
}

model Notification {
  id             String            @id @default(cuid())
  tenantId       String
  channel        NotificationChannel
  recipient      String
  templateKey    String
  payload        Json
  sentAt         DateTime?
  deliveryStatus DeliveryStatus    @default(PENDING)
  errorMessage   String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  tenant         Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([deliveryStatus])
  @@index([createdAt])
}

model Subscription {
  id                   String             @id @default(cuid())
  tenantId             String
  stripeCustomerId     String
  stripeSubscriptionId String
  plan                 SubscriptionPlan
  seats                Int
  status               SubscriptionStatus
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  tenant               Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, stripeSubscriptionId])
}

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String
  actorUserId String?
  entityType  String
  entityId    String
  action      String
  metaJson    Json
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}
